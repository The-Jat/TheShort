class AutoCropHandler{constructor(){this.cropper=null,this.currentFile=null,this.currentInput=null,this.cleanupBackdrops(),this.init()}cleanupBackdrops(){const e=document.querySelectorAll(".modal-backdrop");e.forEach(e=>e.remove())}init(){const e=document.querySelectorAll('input[type="file"][data-auto-crop]');e.forEach(e=>{e.addEventListener("change",e=>this.handleFileChange(e))}),this.initModalEvents()}handleFileChange(e){const t=e.target.files[0];t&&this.validateFile(t,e.target)&&(this.currentFile=t,this.currentInput=e.target,this.loadImageForCropping(t))}validateFile(e,t){const r=t.dataset.allowedExtensions||"jpg,jpeg,png,gif",o=r.split(",").map(e=>e.trim().toLowerCase()),n=t.dataset.maxSize||1024,s=t.dataset.error;if(e.size>1024*n)return $.notify({message:s},{type:"danger",placement:{from:"top",align:"right"}}),!1;const a=e.name.split(".").pop().toLowerCase();return"svg"===a||"webp"===a?($.notify({message:"SVG and WebP files cannot be cropped. Please use JPG, PNG, or GIF files."},{type:"warning",placement:{from:"top",align:"right"}}),!1):o.includes(a)&&!!e.type.startsWith("image/")||($.notify({message:s},{type:"danger",placement:{from:"top",align:"right"}}),!1)}loadImageForCropping(e){const t=new FileReader;t.onload=(e=>{const t=document.getElementById("cropper-image");t&&(t.src=e.target.result,this.openCropperModal())}),t.readAsDataURL(e)}openCropperModal(){const e=new bootstrap.Modal(document.getElementById("cropperModal"));e.show(),setTimeout(()=>this.initCropper(),300)}initCropper(){const e=document.getElementById("cropper-image");e&&(this.cropper&&this.cropper.destroy(),this.cropper=new Cropper(e,{aspectRatio:this.currentInput.dataset.ratio?parseInt(this.currentInput.dataset.ratio.split(":")[0])/parseInt(this.currentInput.dataset.ratio.split(":")[1]):1,viewMode:1,dragMode:"move",autoCropArea:1,restore:!1,guides:!0,center:!0,highlight:!1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!1,ready:()=>{}}))}saveCroppedImage(){if(this.cropper&&this.currentFile&&this.currentInput)try{const e=document.getElementById("cropper-image"),t=e.naturalWidth,r=e.naturalHeight,o=this.cropper.getCroppedCanvas({width:t,height:r,imageSmoothingEnabled:!0,imageSmoothingQuality:"high"});o.toBlob(e=>{this.processCroppedBlob(e)},"image/jpeg",.9)}catch(e){this.showError("Error processing image. Please try again.")}else this.showError("No image to crop")}processCroppedBlob(e){try{const t=this.currentFile.name,r=t.substring(0,t.lastIndexOf(".")),o=t.substring(t.lastIndexOf(".")),n=`${r}_cropped${o}`,s=new File([e],n,{type:this.currentFile.type}),a=new DataTransfer;a.items.add(s),this.currentInput.files=a.files,$(this.currentInput).trigger("change"),this.updatePreview(e),this.closeCropperModal(),this.showSuccess("Image cropped successfully!")}catch(e){this.showError("Error saving cropped image")}}updatePreview(e){const t=this.currentInput.dataset.previewSelector;if(t){const r=document.querySelector(t);r&&(r.src=URL.createObjectURL(e))}}closeCropperModal(){const e=bootstrap.Modal.getInstance(document.getElementById("cropperModal"));e&&e.hide(),setTimeout(()=>{const e=document.querySelectorAll(".modal-backdrop");e.forEach(e=>e.remove())},150),this.currentFile=null,this.currentInput=null}initModalEvents(){const e=document.getElementById("crop-save");e&&e.addEventListener("click",()=>this.saveCroppedImage());const t=document.getElementById("cropperModal");t&&t.addEventListener("hidden.bs.modal",()=>{this.cropper&&(this.cropper.destroy(),this.cropper=null);const e=document.querySelectorAll(".modal-backdrop");e.forEach(e=>e.remove()),this.currentFile=null,this.currentInput=null})}showError(e){}showSuccess(e){}}document.addEventListener("DOMContentLoaded",function(){new AutoCropHandler}),window.cleanupModalBackdrops=function(){const e=document.querySelectorAll(".modal-backdrop");e.forEach(e=>e.remove())};